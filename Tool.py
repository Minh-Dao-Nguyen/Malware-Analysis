import requests
import ghidra_bridge

gb = ghidra_bridge.GhidraBridge(namespace=globals(), hook_import=True)

from ghidra.util.task import TaskMonitor
from ghidra.app.decompiler import DecompInterface

API_KEY = 'YOUR OPEN AI KEY'

def getDecompiledFunc():
    monitor = TaskMonitor.DUMMY
    decompiler = DecompInterface()

    decompiler.openProgram(currentProgram)

    function = getFunctionContaining(currentLocation.getAddress())

    return decompiler.decompileFunction(function, 30, monitor).getDecompiledFunction().getC(), function.getName()


def openai_api(prompt):
    headers = {
        'Content-Type': 'application/json',
        'Authorization': f'Bearer {API_KEY}',
    }
    data = {
        'prompt': prompt,
        'max_tokens': 200,
        'temperature': 0.5,
        'stop': '\n',
    }
    res = requests.post('https://api.openai.com/v1/completions', headers=headers, json=data)
    resJSON = res.json()
    return resJSON['choices'][0]['text']


c_code, funcName = getDecompiledFunc()
print("Explanation: ")
prompt = f"This code is a malware that got decompiled in Ghidra into C code: \n {c_code} \n Please explain this code."
res = openai_api(prompt)

# Comment on the function in Ghidra
function = getFunction(funcName)
function.setComment(res)

print(res)

